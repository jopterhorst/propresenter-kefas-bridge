<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Settings - ProPresenter Kefas Bridge</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
        background: linear-gradient(135deg, #f5f5f7 0%, #e8e8eb 100%);
        min-height: 100vh;
        padding: 12px;
      }

      .container {
        max-width: 500px;
        margin: 0 auto;
      }

      .header {
        text-align: center;
        margin-bottom: 8px;
      }

      .header h1 {
        display: none;
      }

      .header p {
        display: none;
      }

      .card {
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.5);
        border-radius: 18px;
        padding: 16px;
        margin-bottom: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      }

      .card h3 {
        font-size: 16px;
        font-weight: 600;
        color: #1d1d1f;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .section-icon {
        width: 20px;
        height: 20px;
        background: linear-gradient(135deg, #ff9500 0%, #ff6b35 100%);
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 12px;
        font-weight: 700;
      }

      .form-group {
        margin-bottom: 12px;
      }

      .form-group:last-child {
        margin-bottom: 0;
      }

      label {
        display: block;
        font-size: 13px;
        font-weight: 600;
        color: #1d1d1f;
        margin-bottom: 8px;
        letter-spacing: 0.3px;
      }

      input[type="text"],
      input[type="password"],
      input[type="number"] {
        width: 100%;
        padding: 12px 14px;
        border: 1.5px solid rgba(0, 0, 0, 0.08);
        border-radius: 10px;
        font-size: 14px;
        font-family: inherit;
        background: rgba(255, 255, 255, 0.9);
        transition: all 0.2s ease;
      }

      input[type="text"]:focus,
      input[type="password"]:focus,
      input[type="number"]:focus {
        outline: none;
        border-color: #ff9500;
        box-shadow: 0 0 0 3px rgba(255, 149, 0, 0.1);
        background: white;
      }

      input[type="text"]::placeholder,
      input[type="password"]::placeholder,
      input[type="number"]::placeholder {
        color: #a1a1a6;
      }

      input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
      }

      .password-input-wrapper {
        position: relative;
      }

      .password-toggle-btn {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        cursor: pointer;
        color: #a1a1a6;
        font-size: 14px;
        font-weight: 600;
        padding: 4px 8px;
        width: auto;
        transition: color 0.2s ease;
      }

      .password-toggle-btn:hover {
        color: #1d1d1f;
      }

      .password-input-wrapper input {
        padding-right: 50px;
      }

      button {
        width: 100%;
        padding: 11px 16px;
        border: none;
        border-radius: 10px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        letter-spacing: 0.2px;
      }

      .btn-primary {
        background: linear-gradient(135deg, #ff9500 0%, #ff6b35 100%);
        color: white;
        box-shadow: 0 4px 12px rgba(255, 149, 0, 0.3);
      }

      .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 16px rgba(255, 149, 0, 0.4);
      }

      .btn-primary:active {
        transform: translateY(0);
        box-shadow: 0 2px 8px rgba(255, 149, 0, 0.2);
      }

      .info-text {
        font-size: 12px;
        color: #a1a1a6;
        margin-top: 6px;
        line-height: 1.5;
      }

      /* Dark mode support */
      @media (prefers-color-scheme: dark) {
        body {
          background: linear-gradient(135deg, #1d1d1f 0%, #2a2a2e 100%);
        }

        .card {
          background: rgba(45, 45, 50, 0.6);
          border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .card h3 {
          color: #f5f5f7;
        }

        .header h1 {
          color: #f5f5f7;
        }

        .header p {
          color: #a1a1a6;
        }

        label {
          color: #f5f5f7;
        }

        input[type="text"],
        input[type="password"],
        input[type="number"] {
          background: rgba(255, 255, 255, 0.08);
          border-color: rgba(255, 255, 255, 0.1);
          color: #f5f5f7;
        }

        input[type="text"]:focus,
        input[type="password"]:focus,
        input[type="number"]:focus {
          background: rgba(255, 255, 255, 0.12);
          box-shadow: 0 0 0 3px rgba(255, 149, 0, 0.15);
        }

        input[type="text"]::placeholder,
        input[type="password"]::placeholder,
        input[type="number"]::placeholder {
          color: #6f6f77;
        }

        .info-text {
          color: #6f6f77;
        }

        .password-toggle-btn {
          color: #6f6f77;
        }

        .password-toggle-btn:hover {
          color: #f5f5f7;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>Settings</h1>
        <p>Configure ProPresenter and Kefas integration</p>
      </div>

      <!-- Kefas Card -->
      <div class="card">
        <h3>
          Kefas API
        </h3>
        <div class="form-group">
          <label for="tokenInput">API Token</label>
          <div class="password-input-wrapper">
            <input 
              type="password" 
              id="tokenInput" 
              placeholder="Paste your Kefas API token"
            />
            <button type="button" class="password-toggle-btn" id="tokenToggle">Show</button>
          </div>
          <p class="info-text">Your token is stored locally and never sent anywhere except Kefas API.</p>
        </div>
      </div>

      <!-- ProPresenter Card -->
      <div class="card">
        <h3>
          ProPresenter API
        </h3>
        <div class="form-group">
          <label for="hostInput">API Host / IP Address</label>
          <input 
            type="text" 
            id="hostInput" 
            placeholder="127.0.0.1"
          />
          <p class="info-text">IP address or hostname of the ProPresenter machine. Default: 127.0.0.1 (localhost)</p>
        </div>

        <div class="form-group" style="margin-top: 12px; border-top: 1px solid rgba(0,0,0,0.08); padding-top: 12px;">
          <label for="portInput">API Port</label>
          <input 
            type="number" 
            id="portInput" 
            placeholder="55056"
            min="1"
            max="65535"
          />
          <p class="info-text">Default port is 55056. Change if ProPresenter is running on a different port.</p>
        </div>
      </div>

      <!-- Notes Feature Card -->
      <div class="card">
        <h3>
          Notes Feature
        </h3>
        <div class="form-group">
          <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-weight: 500; cursor: pointer;">
            <input type="checkbox" id="useNotesToggle" style="cursor: pointer;">
            <span>Use Notes Instead of Text</span>
          </label>
          <p class="info-text">When the trigger string is found in slide text, use the notes field instead. If slide only contains this string, it's considered empty.</p>
        </div>

        <div class="form-group" style="margin-top: 16px; border-top: 1px solid rgba(0,0,0,0.08); padding-top: 16px;">
          <label for="notesTriggerInput">Notes Trigger String</label>
          <input 
            type="text" 
            id="notesTriggerInput" 
            placeholder="Current Slide Notes"
          />
          <p class="info-text">If slide text contains this string, use notes attribute instead. Default: "Current Slide Notes"</p>
        </div>
      </div>

      <!-- Stream Reconnection Card -->
      <div class="card">
        <h3>
          Stream Reconnection
        </h3>
        <div class="form-group">
          <label for="maxReconnectInput">Max Reconnection Attempts</label>
          <input 
            type="number" 
            id="maxReconnectInput" 
            placeholder="3"
            min="1"
            max="10"
          />
          <p class="info-text">Number of attempts to reconnect if the ProPresenter connection drops. Default: 3</p>
        </div>

        <div class="form-group" style="margin-top: 12px; border-top: 1px solid rgba(0,0,0,0.08); padding-top: 12px;">
          <label for="reconnectDelayInput">Reconnection Delay (seconds)</label>
          <input 
            type="number" 
            id="reconnectDelayInput" 
            placeholder="5"
            min="1"
            max="60"
          />
          <p class="info-text">Wait time between reconnection attempts in seconds. Default: 5</p>
        </div>
      </div>

      <!-- Debug Card -->
      <div class="card">
        <h3>
          Debug
        </h3>
        <div class="form-group">
          <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 0; font-weight: 500; cursor: pointer;">
            <input type="checkbox" id="debugToggle" style="cursor: pointer;">
            <span>Debug Mode</span>
          </label>
          <p class="info-text" style="margin-top: 8px;">Enable verbose logging to browser console. Press Cmd+Option+I to view logs.</p>
        </div>
      </div>

      <!-- Save Button -->
      <button class="btn-primary" id="saveBtn" style="margin-top: 8px; margin-bottom: 32px;">Save and Close</button>
    </div>

    <script>
      const tokenInput = document.getElementById('tokenInput');
      const portInput = document.getElementById('portInput');
      const useNotesToggle = document.getElementById('useNotesToggle');
      const notesTriggerInput = document.getElementById('notesTriggerInput');
      const maxReconnectInput = document.getElementById('maxReconnectInput');
      const reconnectDelayInput = document.getElementById('reconnectDelayInput');
      const debugToggle = document.getElementById('debugToggle');
      const saveBtn = document.getElementById('saveBtn');
      const hostInput = document.getElementById('hostInput');

      // Load settings from localStorage on startup
      function loadSettings() {
        const savedToken = localStorage.getItem('kefasToken');
        if (savedToken) {
          tokenInput.value = savedToken;
        }
        
        const savedHost = localStorage.getItem('proPresenterHost');
        hostInput.value = savedHost || '127.0.0.1';
        
        const savedPort = localStorage.getItem('proPresenterPort');
        portInput.value = savedPort || '55056';
        
        const useNotes = localStorage.getItem('useNotes') === 'true';
        useNotesToggle.checked = useNotes;
        
        const notesTrigger = localStorage.getItem('notesTrigger');
        notesTriggerInput.value = notesTrigger || 'Current Slide Notes';
        
        const debugMode = localStorage.getItem('debugMode') === 'true';
        debugToggle.checked = debugMode;
        
        const maxReconnect = localStorage.getItem('maxReconnectAttempts');
        maxReconnectInput.value = maxReconnect || '3';
        
        const reconnectDelay = localStorage.getItem('reconnectDelayMs');
        reconnectDelayInput.value = (reconnectDelay ? parseInt(reconnectDelay) / 1000 : '5');
      }

      // Save settings to localStorage
      function saveSettings() {
        const token = tokenInput.value.trim();
        if (!token) {
          alert('Kefas token cannot be empty.');
          return;
        }
        
        const host = hostInput.value.trim();
        if (!host) {
          alert('ProPresenter host cannot be empty.');
          return;
        }
        
        const port = parseInt(portInput.value);
        if (!port || port < 1 || port > 65535) {
          alert('Port must be between 1 and 65535.');
          return;
        }
        
        const notesTrigger = notesTriggerInput.value.trim();
        if (!notesTrigger) {
          alert('Notes trigger string cannot be empty.');
          return;
        }
        
        const maxReconnect = parseInt(maxReconnectInput.value);
        if (!maxReconnect || maxReconnect < 1 || maxReconnect > 10) {
          alert('Max reconnection attempts must be between 1 and 10.');
          return;
        }
        
        const reconnectDelay = parseInt(reconnectDelayInput.value);
        if (!reconnectDelay || reconnectDelay < 1 || reconnectDelay > 60) {
          alert('Reconnection delay must be between 1 and 60 seconds.');
          return;
        }
        
        localStorage.setItem('kefasToken', token);
        localStorage.setItem('proPresenterHost', host);
        localStorage.setItem('proPresenterPort', port);
        localStorage.setItem('useNotes', useNotesToggle.checked ? 'true' : 'false');
        localStorage.setItem('notesTrigger', notesTrigger);
        localStorage.setItem('maxReconnectAttempts', maxReconnect);
        localStorage.setItem('reconnectDelayMs', reconnectDelay * 1000);
        localStorage.setItem('debugMode', debugToggle.checked ? 'true' : 'false');
        
        window.close();
      }

      // Add keyboard paste support
      function setupClipboard() {
        document.addEventListener('keydown', async (e) => {
          if ((e.metaKey || e.ctrlKey) && e.key === 'v') {
            const target = document.activeElement;
            if (target.matches('input[type="text"], input[type="password"], input[type="number"]')) {
              e.preventDefault();
              try {
                const text = await window.clipboard.readText();
                target.value += text;
              } catch (err) {
                console.error('Paste failed:', err);
              }
            }
          }
        });
      }

      // Toggle token visibility
      function setupPasswordToggles() {
        const tokenToggle = document.getElementById('tokenToggle');

        tokenToggle.addEventListener('click', (e) => {
          e.preventDefault();
          const input = document.getElementById('tokenInput');
          const isPassword = input.type === 'password';
          input.type = isPassword ? 'text' : 'password';
          tokenToggle.textContent = isPassword ? 'Hide' : 'Show';
        });
      }

      saveBtn.addEventListener('click', saveSettings);
      
      // Initialize
      loadSettings();
      setupClipboard();
      setupPasswordToggles();
    </script>
  </body>
</html>
